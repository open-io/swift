name: swift
version: v2.0

workflow:
  root:
    pipeline: swift-root
    application: swift

  test:
    pipeline: swift-code-tests
    application: swift
    conditions:
      check:
        - variable: cds.triggered_by.username
          operator: ne
          value: "cds.scheduler"
    depends_on:
      - root

  mirror:
    pipeline: swift-mirror
    application: swift
    depends_on:
      - root

  build:
    pipeline: swift-build
    application: swift
    depends_on:
      - root
    conditions:
      check:
        - variable: cds.triggered_by.username
          operator: ne
          value: "cds.scheduler"

  tests-unit:
    pipeline: swift-tests
    application: swift
    environment: swift-tests-unit-env
    depends_on:
      - root
    conditions:
      check:
        - variable: cds.triggered_by.username
          operator: ne
          value: "cds.scheduler"

  tests-s3:
    pipeline: swift-tests
    application: swift
    environment: swift-tests-s3-env
    depends_on:
      - root
    conditions:
      check:
        - variable: cds.triggered_by.username
          operator: ne
          value: "cds.scheduler"

  tests-s3-basic:
    pipeline: swift-tests
    application: swift
    environment: swift-tests-s3-basic-env
    depends_on:
      - root
    conditions:
      check:
        - variable: cds.triggered_by.username
          operator: ne
          value: "cds.scheduler"

  tests-iam:
    pipeline: swift-tests
    application: swift
    environment: swift-tests-iam-env
    depends_on:
      - root
    conditions:
      check:
        - variable: cds.triggered_by.username
          operator: ne
          value: "cds.scheduler"

  tests-reports:
    pipeline: swift-tests-reports
    application: swift
    depends_on:
      - tests-unit
      - tests-s3
      - tests-s3-basic
      - tests-iam
    conditions:
      check:
        - variable: cds.triggered_by.username
          operator: ne
          value: "cds.scheduler"

metadata:
  default_tags: git.branch,git.author,git.tag

retention_policy: "if(cds_triggered_by_username == 'cds.scheduler') then\n  return run_days_before < 1\nend\nif(has_git_branch == \"true\") then\n  if(git_branch_exist == \"true\") then    \n    return run_days_before < 365\n  else\n    return run_days_before < 2\n  end\nelse\n  return run_days_before < 365\nend"

notifications:
  - type: vcs
    settings:
      on_success: always

hooks:
  root:
    - type: Scheduler
      config:
        # twice a day
        cron: "17 13,21 * * *"
        timezone: UTC
